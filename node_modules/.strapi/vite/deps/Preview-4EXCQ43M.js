import {
  getDocumentStatus
} from "./chunk-HTC5FB4R.js";
import {
  FormLayout
} from "./chunk-RXBOAHU3.js";
import "./chunk-3KM43LT6.js";
import "./chunk-2NMTB7OO.js";
import "./chunk-C6F7BL7O.js";
import "./chunk-SYWYLB7I.js";
import {
  useGetPreviewUrlQuery
} from "./chunk-NC5BDQC2.js";
import "./chunk-VLHKB3Y4.js";
import {
  InjectionZone
} from "./chunk-ACF43MI6.js";
import "./chunk-6KDH7GW3.js";
import "./chunk-CFXYFXJS.js";
import "./chunk-RB2GXEEE.js";
import {
  DocumentActionButton,
  DocumentContextProvider,
  DocumentRBAC,
  DocumentStatus,
  useDocumentContext
} from "./chunk-ER3PRL7C.js";
import {
  COLLECTION_TYPES,
  buildValidParams,
  createYupSchema,
  useDocument,
  useDocumentLayout
} from "./chunk-JIFANRG6.js";
import "./chunk-HIZVCZYI.js";
import "./chunk-6LY4MOO2.js";
import {
  DescriptionComponentRenderer
} from "./chunk-SRRQNXXB.js";
import "./chunk-O3R4VP3I.js";
import "./chunk-PC5KKJEK.js";
import "./chunk-3HTKFRD7.js";
import "./chunk-4J3VOWQV.js";
import "./chunk-XHMF7CWR.js";
import "./chunk-GPI2VHC2.js";
import "./chunk-IJBKCR3K.js";
import "./chunk-62O4LC6R.js";
import "./chunk-J7F5HCRS.js";
import "./chunk-3DIXLFXX.js";
import "./chunk-5UIJKBWB.js";
import "./chunk-IIRI6BQS.js";
import "./chunk-35KGNMCE.js";
import "./chunk-N2WHARAX.js";
import "./chunk-U52DOU27.js";
import "./chunk-QNEIYZZW.js";
import "./chunk-MBK4V2X7.js";
import "./chunk-3FDN6LLF.js";
import "./chunk-K65KIEAL.js";
import "./chunk-N6L25CPB.js";
import "./chunk-6VZBWNIX.js";
import {
  useHistory
} from "./chunk-Q65EZ4WN.js";
import "./chunk-E6CXZI45.js";
import "./chunk-43MLUMYN.js";
import "./chunk-AWEPTK4E.js";
import "./chunk-QIJGNK42.js";
import {
  useClipboard
} from "./chunk-HUXU7IBC.js";
import "./chunk-ABXPREUU.js";
import "./chunk-234RJMMH.js";
import "./chunk-NKLJM66F.js";
import "./chunk-7DAG4T7B.js";
import "./chunk-JM6GQQDV.js";
import "./chunk-D4WYVNVM.js";
import "./chunk-MMOBCIZG.js";
import "./chunk-IFOFBKTA.js";
import "./chunk-L7CKIK7M.js";
import "./chunk-EGNP2T5O.js";
import "./chunk-YXDCVYVT.js";
import "./chunk-OM3P6XJP.js";
import {
  Blocker,
  Form
} from "./chunk-W2EBIS6P.js";
import {
  useRBAC
} from "./chunk-2YJPP6F5.js";
import "./chunk-GVM5AFPO.js";
import "./chunk-LGTUBU5N.js";
import "./chunk-PQINNV4N.js";
import "./chunk-VYSYYPOB.js";
import {
  Page
} from "./chunk-LQ66U5BX.js";
import {
  useQueryParams,
  useStrapiApp
} from "./chunk-7IDP7SCX.js";
import "./chunk-RQ66TRCK.js";
import "./chunk-BHLYCXQ7.js";
import {
  createContext
} from "./chunk-2W3NWVKQ.js";
import {
  useNotification
} from "./chunk-GSOKMUI2.js";
import {
  require_lib
} from "./chunk-MV7EAZLN.js";
import "./chunk-H5GOECOZ.js";
import "./chunk-CE4VABH2.js";
import "./chunk-5VODLFKF.js";
import {
  Box,
  Flex,
  FocusTrap,
  IconButton,
  Portal$1,
  Tabs,
  Typography,
  useIntl
} from "./chunk-GEQAKZDT.js";
import "./chunk-5ZC4PE57.js";
import {
  Link,
  useLocation,
  useParams
} from "./chunk-TUXTO2Z5.js";
import "./chunk-FOD4ENRR.js";
import {
  ForwardRef$2r,
  ForwardRef$45,
  ForwardRef$5h
} from "./chunk-QXF2FKMZ.js";
import {
  require_jsx_runtime
} from "./chunk-NIAJZ5MX.js";
import {
  dt
} from "./chunk-6EUTJK7T.js";
import {
  require_react
} from "./chunk-MADUDGYZ.js";
import {
  __toESM
} from "./chunk-PLDDJCW6.js";

// node_modules/@strapi/content-manager/dist/admin/preview/pages/Preview.mjs
var import_jsx_runtime2 = __toESM(require_jsx_runtime(), 1);
var React = __toESM(require_react(), 1);

// node_modules/@strapi/content-manager/dist/admin/preview/components/PreviewHeader.mjs
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var import_react = __toESM(require_react(), 1);
var import_qs = __toESM(require_lib(), 1);
var ClosePreviewButton = () => {
  const [{ query }] = useQueryParams();
  const { formatMessage } = useIntl();
  const canGoBack = useHistory("BackButton", (state) => state.canGoBack);
  const goBack = useHistory("BackButton", (state) => state.goBack);
  const history = useHistory("BackButton", (state) => state.history);
  const locationIndex = useHistory("BackButton", (state) => state.currentLocationIndex);
  const historyTo = canGoBack ? history.at(locationIndex - 2) : void 0;
  const fallback = {
    pathname: "..",
    search: (0, import_qs.stringify)(query, {
      encode: false
    })
  };
  const toWithFallback = historyTo ?? fallback;
  const handleClick = (e) => {
    if (canGoBack) {
      e.preventDefault();
      goBack();
      return;
    }
  };
  return (0, import_jsx_runtime.jsx)(IconButton, {
    variant: "ghost",
    tag: Link,
    relative: "path",
    to: toWithFallback,
    onClick: handleClick,
    label: formatMessage({
      id: "content-manager.preview.header.close",
      defaultMessage: "Close preview"
    }),
    children: (0, import_jsx_runtime.jsx)(ForwardRef$45, {})
  });
};
var Status = () => {
  var _a;
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  const meta = usePreviewContext("PreviewHeader", (state) => state.meta);
  const hasDraftAndPublished = ((_a = schema == null ? void 0 : schema.options) == null ? void 0 : _a.draftAndPublish) ?? false;
  if (!hasDraftAndPublished) {
    return null;
  }
  const status = getDocumentStatus(document, meta);
  return (0, import_jsx_runtime.jsx)(DocumentStatus, {
    status,
    size: "XS"
  });
};
var PreviewTabs = () => {
  var _a;
  const { formatMessage } = useIntl();
  const [{ query }, setQuery] = useQueryParams();
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  const meta = usePreviewContext("PreviewHeader", (state) => state.meta);
  const hasDraftAndPublish = ((_a = schema == null ? void 0 : schema.options) == null ? void 0 : _a.draftAndPublish) ?? false;
  const documentStatus = getDocumentStatus(document, meta);
  const handleTabChange = (status) => {
    if (status === "published" || status === "draft") {
      setQuery({
        status
      }, "push", true);
    }
  };
  if (!hasDraftAndPublish) {
    return null;
  }
  return (0, import_jsx_runtime.jsx)(Tabs.Root, {
    variant: "simple",
    value: query.status || "draft",
    onValueChange: handleTabChange,
    children: (0, import_jsx_runtime.jsxs)(Tabs.List, {
      "aria-label": formatMessage({
        id: "preview.tabs.label",
        defaultMessage: "Document status"
      }),
      children: [
        (0, import_jsx_runtime.jsx)(StatusTab, {
          value: "draft",
          children: formatMessage({
            id: "content-manager.containers.List.draft",
            defaultMessage: "draft"
          })
        }),
        (0, import_jsx_runtime.jsx)(StatusTab, {
          value: "published",
          disabled: documentStatus === "draft",
          children: formatMessage({
            id: "content-manager.containers.List.published",
            defaultMessage: "published"
          })
        })
      ]
    })
  });
};
var PreviewHeader = () => {
  var _a;
  const title = usePreviewContext("PreviewHeader", (state) => state.title);
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  const meta = usePreviewContext("PreviewHeader", (state) => state.meta);
  const plugins = useStrapiApp("PreviewHeader", (state) => state.plugins);
  const onPreview = useDocumentContext("PreviewHeader", (state) => state.onPreview);
  const [{ query }] = useQueryParams();
  const { formatMessage } = useIntl();
  const { toggleNotification } = useNotification();
  const { copy } = useClipboard();
  const handleCopyLink = () => {
    copy(window.location.href);
    toggleNotification({
      message: formatMessage({
        id: "content-manager.preview.copy.success",
        defaultMessage: "Copied preview link"
      }),
      type: "success"
    });
  };
  const hasDraftAndPublish = ((_a = schema.options) == null ? void 0 : _a.draftAndPublish) ?? false;
  const documentActionProps = {
    activeTab: query.status ?? null,
    collectionType: schema.kind === "collectionType" ? "collection-types" : "single-types",
    model: schema.uid,
    documentId: document.documentId,
    document,
    meta,
    onPreview,
    fromPreview: true
  };
  return (0, import_jsx_runtime.jsxs)(Flex, {
    height: "48px",
    gap: 4,
    background: "neutral0",
    borderColor: "neutral150",
    tag: "header",
    children: [
      (0, import_jsx_runtime.jsxs)(TitleContainer, {
        height: "100%",
        paddingLeft: 2,
        paddingRight: 4,
        children: [
          (0, import_jsx_runtime.jsx)(ClosePreviewButton, {}),
          (0, import_jsx_runtime.jsx)(PreviewTitle, {
            tag: "h1",
            title,
            maxWidth: "200px",
            fontSize: 2,
            paddingLeft: 2,
            paddingRight: 3,
            fontWeight: 600,
            children: title
          }),
          (0, import_jsx_runtime.jsx)(Status, {})
        ]
      }),
      (0, import_jsx_runtime.jsxs)(Flex, {
        flex: 1,
        paddingRight: 2,
        gap: 2,
        justifyContent: hasDraftAndPublish ? "space-between" : "flex-end",
        children: [
          (0, import_jsx_runtime.jsx)(Flex, {
            flex: "1 1 70%",
            children: (0, import_jsx_runtime.jsx)(PreviewTabs, {})
          }),
          (0, import_jsx_runtime.jsxs)(Flex, {
            gap: 2,
            children: [
              (0, import_jsx_runtime.jsx)(IconButton, {
                type: "button",
                label: formatMessage({
                  id: "preview.copy.label",
                  defaultMessage: "Copy preview link"
                }),
                onClick: handleCopyLink,
                children: (0, import_jsx_runtime.jsx)(ForwardRef$2r, {})
              }),
              (0, import_jsx_runtime.jsx)(InjectionZone, {
                area: "preview.actions"
              }),
              (0, import_jsx_runtime.jsx)(DescriptionComponentRenderer, {
                props: documentActionProps,
                descriptions: plugins["content-manager"].apis.getDocumentActions("preview"),
                children: (actions) => {
                  const filteredActions = actions.filter((action) => [
                    action.position
                  ].flat().includes("preview"));
                  const [primaryAction, secondaryAction] = filteredActions;
                  if (!primaryAction && !secondaryAction) return null;
                  if (primaryAction && secondaryAction) {
                    return (0, import_jsx_runtime.jsxs)(import_jsx_runtime.Fragment, {
                      children: [
                        (0, import_jsx_runtime.jsx)(DocumentActionButton, {
                          ...secondaryAction,
                          variant: secondaryAction.variant || "secondary"
                        }),
                        (0, import_jsx_runtime.jsx)(DocumentActionButton, {
                          ...primaryAction,
                          variant: primaryAction.variant || "default"
                        })
                      ]
                    });
                  }
                  return (0, import_jsx_runtime.jsx)(DocumentActionButton, {
                    ...primaryAction,
                    variant: primaryAction.variant || "secondary"
                  });
                }
              })
            ]
          })
        ]
      })
    ]
  });
};
var PreviewTitle = dt(Typography)`
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`;
var StatusTab = dt(Tabs.Trigger)`
  text-transform: uppercase;
`;
var TitleContainer = dt(Flex)`
  border-right: 1px solid ${({ theme }) => theme.colors.neutral150};
`;

// node_modules/@strapi/content-manager/dist/admin/preview/pages/Preview.mjs
var [PreviewProvider, usePreviewContext] = createContext("PreviewPage");
var AnimatedArrow = dt(ForwardRef$5h)`
  will-change: transform;
  rotate: ${(props) => props.isSideEditorOpen ? "0deg" : "180deg"};
  transition: rotate 0.2s ease-in-out;
`;
var PreviewPage = () => {
  var _a, _b, _c, _d;
  const location = useLocation();
  const { formatMessage } = useIntl();
  const iframeRef = React.useRef(null);
  const [isSideEditorOpen, setIsSideEditorOpen] = React.useState(true);
  const { slug: model, id: documentId, collectionType } = useParams();
  const [{ query }] = useQueryParams();
  const params = React.useMemo(() => buildValidParams(query), [
    query
  ]);
  if (!collectionType) {
    throw new Error("Could not find collectionType in url params");
  }
  if (!model) {
    throw new Error("Could not find model in url params");
  }
  if (collectionType === COLLECTION_TYPES && !documentId) {
    throw new Error("Could not find documentId in url params");
  }
  const previewUrlResponse = useGetPreviewUrlQuery({
    params: {
      contentType: model
    },
    query: {
      documentId,
      locale: params.locale,
      status: params.status
    }
  });
  const documentResponse = useDocument({
    model,
    collectionType,
    documentId,
    params
  });
  const documentLayoutResponse = useDocumentLayout(model);
  const isLoading = previewUrlResponse.isLoading || documentLayoutResponse.isLoading || documentResponse.isLoading;
  if (isLoading && !((_a = documentResponse.document) == null ? void 0 : _a.documentId)) {
    return (0, import_jsx_runtime2.jsx)(Page.Loading, {});
  }
  const initialValues = documentResponse.getInitialFormValues();
  if (previewUrlResponse.error || documentLayoutResponse.error || !documentResponse.document || !documentResponse.meta || !documentResponse.schema || !initialValues) {
    return (0, import_jsx_runtime2.jsx)(Page.Error, {});
  }
  if (!((_c = (_b = previewUrlResponse.data) == null ? void 0 : _b.data) == null ? void 0 : _c.url)) {
    return (0, import_jsx_runtime2.jsx)(Page.NoData, {});
  }
  const documentTitle = documentResponse.getTitle(documentLayoutResponse.edit.settings.mainField);
  const validateSync = (values, options) => {
    var _a2, _b2;
    const yupSchema = createYupSchema((_a2 = documentResponse.schema) == null ? void 0 : _a2.attributes, documentResponse.components, {
      status: (_b2 = documentResponse.document) == null ? void 0 : _b2.status,
      ...options
    });
    return yupSchema.validateSync(values, {
      abortEarly: false
    });
  };
  const previewUrl = previewUrlResponse.data.data.url;
  const onPreview = () => {
    var _a2, _b2;
    (_b2 = (_a2 = iframeRef == null ? void 0 : iframeRef.current) == null ? void 0 : _a2.contentWindow) == null ? void 0 : _b2.postMessage(
      {
        type: "strapiUpdate"
      },
      // The iframe origin is safe to use since it must be provided through the allowedOrigins config
      new URL(iframeRef.current.src).origin
    );
  };
  const hasAdvancedPreview = window.strapi.features.isEnabled("cms-advanced-preview");
  return (0, import_jsx_runtime2.jsxs)(import_jsx_runtime2.Fragment, {
    children: [
      (0, import_jsx_runtime2.jsx)(Page.Title, {
        children: formatMessage({
          id: "content-manager.preview.page-title",
          defaultMessage: "{contentType} preview"
        }, {
          contentType: documentTitle
        })
      }),
      (0, import_jsx_runtime2.jsx)(DocumentContextProvider, {
        initialDocument: {
          documentId: documentId || "",
          model,
          collectionType
        },
        onPreview,
        children: (0, import_jsx_runtime2.jsx)(PreviewProvider, {
          url: previewUrl,
          document: documentResponse.document,
          title: documentTitle,
          meta: documentResponse.meta,
          schema: documentResponse.schema,
          layout: documentLayoutResponse.edit,
          children: (0, import_jsx_runtime2.jsx)(Form, {
            method: "PUT",
            disabled: query.status === "published" && documentResponse && documentResponse.document.status === "published",
            initialValues: documentResponse.getInitialFormValues(),
            initialErrors: ((_d = location == null ? void 0 : location.state) == null ? void 0 : _d.forceValidation) ? validateSync(initialValues, {}) : {},
            height: "100%",
            validate: (values, options) => {
              var _a2, _b2;
              const yupSchema = createYupSchema((_a2 = documentResponse.schema) == null ? void 0 : _a2.attributes, documentResponse.components, {
                status: (_b2 = documentResponse.document) == null ? void 0 : _b2.status,
                ...options
              });
              return yupSchema.validate(values, {
                abortEarly: false
              });
            },
            children: ({ resetForm }) => (0, import_jsx_runtime2.jsxs)(Flex, {
              direction: "column",
              height: "100%",
              alignItems: "stretch",
              children: [
                (0, import_jsx_runtime2.jsx)(Blocker, {
                  onProceed: resetForm
                }),
                (0, import_jsx_runtime2.jsx)(PreviewHeader, {}),
                (0, import_jsx_runtime2.jsxs)(Flex, {
                  flex: 1,
                  overflow: "auto",
                  alignItems: "stretch",
                  children: [
                    hasAdvancedPreview && (0, import_jsx_runtime2.jsx)(Box, {
                      overflow: "auto",
                      width: isSideEditorOpen ? "50%" : 0,
                      borderWidth: "0 1px 0 0",
                      borderColor: "neutral150",
                      paddingTop: 6,
                      paddingBottom: 6,
                      // Remove horizontal padding when the editor is closed or it won't fully disappear
                      paddingLeft: isSideEditorOpen ? 6 : 0,
                      paddingRight: isSideEditorOpen ? 6 : 0,
                      transition: "all 0.2s ease-in-out",
                      children: (0, import_jsx_runtime2.jsx)(FormLayout, {
                        layout: documentLayoutResponse.edit.layout,
                        document: documentResponse,
                        hasBackground: false
                      })
                    }),
                    (0, import_jsx_runtime2.jsxs)(Box, {
                      position: "relative",
                      flex: 1,
                      height: "100%",
                      overflow: "hidden",
                      children: [
                        (0, import_jsx_runtime2.jsx)(Box, {
                          "data-testid": "preview-iframe",
                          ref: iframeRef,
                          src: previewUrl,
                          title: formatMessage({
                            id: "content-manager.preview.panel.title",
                            defaultMessage: "Preview"
                          }),
                          width: "100%",
                          height: "100%",
                          borderWidth: 0,
                          tag: "iframe"
                        }, previewUrl),
                        hasAdvancedPreview && (0, import_jsx_runtime2.jsx)(IconButton, {
                          variant: "tertiary",
                          label: formatMessage(isSideEditorOpen ? {
                            id: "content-manager.preview.content.close-editor",
                            defaultMessage: "Close editor"
                          } : {
                            id: "content-manager.preview.content.open-editor",
                            defaultMessage: "Open editor"
                          }),
                          onClick: () => setIsSideEditorOpen((prev) => !prev),
                          position: "absolute",
                          top: 2,
                          left: 2,
                          children: (0, import_jsx_runtime2.jsx)(AnimatedArrow, {
                            isSideEditorOpen
                          })
                        })
                      ]
                    })
                  ]
                })
              ]
            })
          })
        })
      })
    ]
  });
};
var ProtectedPreviewPageImpl = () => {
  const { slug: model } = useParams();
  const { permissions = [], isLoading, error } = useRBAC([
    {
      action: "plugin::content-manager.explorer.read",
      subject: model
    },
    {
      action: "plugin::content-manager.explorer.update",
      subject: model
    },
    {
      action: "plugin::content-manager.explorer.publish",
      subject: model
    }
  ]);
  if (isLoading) {
    return (0, import_jsx_runtime2.jsx)(Page.Loading, {});
  }
  if (error || !model) {
    return (0, import_jsx_runtime2.jsx)(Box, {
      height: "100vh",
      width: "100vw",
      position: "fixed",
      top: 0,
      left: 0,
      zIndex: 2,
      background: "neutral0",
      children: (0, import_jsx_runtime2.jsx)(Page.Error, {})
    });
  }
  return (0, import_jsx_runtime2.jsx)(Box, {
    height: "100vh",
    width: "100vw",
    position: "fixed",
    top: 0,
    left: 0,
    zIndex: 2,
    background: "neutral0",
    children: (0, import_jsx_runtime2.jsx)(Page.Protect, {
      permissions: permissions.filter((permission) => permission.action.includes("explorer.read")),
      children: (0, import_jsx_runtime2.jsx)(DocumentRBAC, {
        permissions,
        children: (0, import_jsx_runtime2.jsx)(PreviewPage, {})
      })
    })
  });
};
var ProtectedPreviewPage = () => {
  return (0, import_jsx_runtime2.jsx)(Portal$1, {
    children: (0, import_jsx_runtime2.jsx)(FocusTrap, {
      children: (0, import_jsx_runtime2.jsx)(ProtectedPreviewPageImpl, {})
    })
  });
};
export {
  ProtectedPreviewPage,
  usePreviewContext
};
//# sourceMappingURL=Preview-4EXCQ43M.js.map
